name: daily-rollup-phase2

on:
  schedule:
    - cron: "10 9 * * *" # 09:10 UTC buffer
  workflow_dispatch:
    inputs:
      day:
        description: "Optional day. Accepts YYYY-MM-DD or YYYYMMDD. If blank: use yesterday if present else latest day found under data/raw."
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: daily-rollup-phase2
  cancel-in-progress: false

jobs:
  rollup:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout DATA branch first so data/raw exists on the runner
      - name: Checkout data branch (contains data/raw)
        uses: actions/checkout@v4
        with:
          ref: data
          fetch-depth: 0

      # 2) Sync code from main into data (fail on conflicts; don't hide failures)
      - name: Fetch + merge main into data (fail on conflicts)
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main
          if ! git merge origin/main --no-edit; then
            echo "ERROR: merge conflict merging main -> data"
            echo "---- git status ----"
            git status --porcelain
            echo "---- conflicted files ----"
            git diff --name-only --diff-filter=U || true
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (including local package)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      # 3) Robust DAY resolution:
      #    - Supports day folders in formats:
      #      A) data/raw/YYYY-MM-DD
      #      B) data/raw/YYYY/MM/DD
      #      C) data/raw/YYYYMMDD
      #
      #    Outputs:
      #      day      = YYYY-MM-DD (normalized label used in out paths)
      #      daydir   = actual directory path in repo where that day lives
      #      inroot   = sequences/ or latest/ inside daydir
      #      outmaster/outframes/outdir as before
      - name: Resolve DAY + input roots (robust formats)
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          RAWROOT="data/raw"
          INPUT_DAY="${{ github.event.inputs.day }}"

          norm_day() {
            # Convert YYYYMMDD -> YYYY-MM-DD; pass-through YYYY-MM-DD
            local d="$1"
            if [[ "$d" =~ ^[0-9]{8}$ ]]; then
              echo "${d:0:4}-${d:4:2}-${d:6:2}"
            else
              echo "$d"
            fi
          }

          # Find all candidate day directories under data/raw in multiple layouts.
          # Prints lines: "<YYYY-MM-DD>|<actual_dir_path>"
          collect_days() {
            local root="$1"

            # A) data/raw/YYYY-MM-DD
            if [[ -d "$root" ]]; then
              find "$root" -maxdepth 1 -mindepth 1 -type d -printf '%f|%p\n' \
                | awk -F'|' '$1 ~ /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/ {print}'
            fi

            # B) data/raw/YYYY/MM/DD  (depth 3)
            if [[ -d "$root" ]]; then
              find "$root" -maxdepth 3 -mindepth 3 -type d -printf '%p\n' \
                | awk -v root="$root" '
                  BEGIN{FS="/"}
                  {
                    # last 3 components are Y/M/D
                    n=split($0,a,"/");
                    y=a[n-2]; m=a[n-1]; d=a[n];
                    if (y ~ /^[0-9]{4}$/ && m ~ /^[0-9]{2}$/ && d ~ /^[0-9]{2}$/) {
                      printf "%s-%s-%s|%s\n", y,m,d,$0
                    }
                  }'
            fi

            # C) data/raw/YYYYMMDD
            if [[ -d "$root" ]]; then
              find "$root" -maxdepth 1 -mindepth 1 -type d -printf '%f|%p\n' \
                | awk -F'|' '$1 ~ /^[0-9]{8}$/ { 
                    y=substr($1,1,4); m=substr($1,5,2); d=substr($1,7,2);
                    printf "%s-%s-%s|%s\n", y,m,d,$2
                  }'
            fi
          }

          mapfile -t CANDS < <(collect_days "$RAWROOT" | sort -t'|' -k1,1)

          echo "---- Debug: data/raw listing ----"
          ls -la "$RAWROOT" 2>/dev/null || true
          echo "---- Debug: discovered candidate days ----"
          if (( ${#CANDS[@]} > 0 )); then
            printf '%s\n' "${CANDS[@]}" | head -n 50
          else
            echo "(none)"
          fi

          # Choose DAY + DAYDIR:
          # 1) explicit input (YYYY-MM-DD or YYYYMMDD)
          # 2) yesterday UTC if present
          # 3) latest discovered
          if [[ -n "$INPUT_DAY" ]]; then
            DAY="$(norm_day "$INPUT_DAY")"
            # Find matching candidate
            DAYDIR="$(printf '%s\n' "${CANDS[@]}" | awk -F'|' -v day="$DAY" '$1==day {print $2}' | tail -n 1 || true)"
            if [[ -z "$DAYDIR" ]]; then
              echo "ERROR: Input day '$INPUT_DAY' normalized to '$DAY' not found under $RAWROOT in any supported layout."
              echo "Hint: ensure your ingest committed day folders to the data branch."
              exit 1
            fi
          else
            YDAY="$(date -u -d "yesterday" +%F)"
            DAYDIR="$(printf '%s\n' "${CANDS[@]}" | awk -F'|' -v day="$YDAY" '$1==day {print $2}' | tail -n 1 || true)"
            if [[ -n "$DAYDIR" ]]; then
              DAY="$YDAY"
            else
              # Latest discovered (by normalized day string)
              if (( ${#CANDS[@]} == 0 )); then
                echo "ERROR: No day folders found under $RAWROOT."
                echo "Expected one of:"
                echo "  - $RAWROOT/YYYY-MM-DD/"
                echo "  - $RAWROOT/YYYY/MM/DD/"
                echo "  - $RAWROOT/YYYYMMDD/"
                echo ""
                echo "This usually means your data branch does not actually contain committed raw imagery."
                echo "If your ingest runs elsewhere, commit/push the raw day folders to the 'data' branch (or adjust RAWROOT)."
                exit 1
              fi
              LAST="$(printf '%s\n' "${CANDS[@]}" | tail -n 1)"
              DAY="${LAST%%|*}"
              DAYDIR="${LAST#*|}"
            fi
          fi

          echo "Resolved DAY=$DAY"
          echo "Resolved DAYDIR=$DAYDIR"

          INSEQ="${DAYDIR}/sequences"
          INLATEST="${DAYDIR}/latest"

          if [[ -d "${INSEQ}" ]]; then
            INROOT="${INSEQ}"
          elif [[ -d "${INLATEST}" ]]; then
            INROOT="${INLATEST}"
          else
            echo "ERROR: Neither ${INSEQ} nor ${INLATEST} exists."
            echo "Day directory exists, but ingest outputs are not in expected subfolders."
            echo "---- Debug: daydir contents ----"
            ls -la "${DAYDIR}" || true
            exit 1
          fi

          OUTMASTER="${DAYDIR}/master"
          OUTFRAMES="${DAYDIR}/master/frames"
          OUTDIR="out/${DAY}/daily"

          echo "day=${DAY}" >> "$GITHUB_OUTPUT"
          echo "daydir=${DAYDIR}" >> "$GITHUB_OUTPUT"
          echo "inroot=${INROOT}" >> "$GITHUB_OUTPUT"
          echo "outmaster=${OUTMASTER}" >> "$GITHUB_OUTPUT"
          echo "outframes=${OUTFRAMES}" >> "$GITHUB_OUTPUT"
          echo "outdir=${OUTDIR}" >> "$GITHUB_OUTPUT"

      # Extra debug snapshot (kept short but decisive)
      - name: Debug: show resolved paths + trees
        shell: bash
        run: |
          set -euo pipefail
          echo "DAY=${{ steps.resolve.outputs.day }}"
          echo "DAYDIR=${{ steps.resolve.outputs.daydir }}"
          echo "INROOT=${{ steps.resolve.outputs.inroot }}"
          echo "OUTMASTER=${{ steps.resolve.outputs.outmaster }}"
          echo "OUTFRAMES=${{ steps.resolve.outputs.outframes }}"
          echo "OUTDIR=${{ steps.resolve.outputs.outdir }}"

          echo "---- DAYDIR tree (2 levels) ----"
          find "${{ steps.resolve.outputs.daydir }}" -maxdepth 2 -type d -print || true

          echo "---- scripts/pipeline listing ----"
          ls -la scripts/pipeline || true

      # 4) Stage frames into master/frames (copy + recursive)
      - name: Stage sequences -> daily master
        shell: bash
        run: |
          set -euo pipefail
          INROOT="${{ steps.resolve.outputs.inroot }}"
          OUTMASTER="${{ steps.resolve.outputs.outmaster }}"
          mkdir -p "${OUTMASTER}"

          python scripts/pipeline/stage_frames.py \
            --inputs "${INROOT}" \
            --outdir "${OUTMASTER}" \
            --recursive \
            --mode copy

          test -d "${{ steps.resolve.outputs.outframes }}" || (echo "ERROR: Missing frames dir after staging" && exit 1)

      # 5) Run Phase 2 on master frames
      - name: Run Phase 2 on daily master
        shell: bash
        run: |
          set -euo pipefail
          RAWDIR="${{ steps.resolve.outputs.outframes }}"
          OUTDIR="${{ steps.resolve.outputs.outdir }}"
          mkdir -p "${OUTDIR}"

          python scripts/pipeline/run_sample_pipeline.py \
            --raw-dir "${RAWDIR}" \
            --outdir "${OUTDIR}" \
            --save-overlays

      # 6) Commit results back to data branch
      - name: Commit daily master + outputs to data branch
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git add -f data/raw out || true
          git commit -m "rollup+phase2(daily): ${{ steps.resolve.outputs.day }} @ $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "No changes"
          git push origin data




