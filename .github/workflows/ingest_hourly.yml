name: ingest-hourly

on:
  schedule:
    - cron: "0 * * * *"   # hourly (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ingest-hourly
  cancel-in-progress: false

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main (code)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch data branch
        run: git fetch origin data

      - name: Switch to data branch and sync code from main
        run: |
          set -e
          git switch data || git switch -c data
          git merge origin/main --no-edit || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Hourly ingest (save ~24 frames)
        env:
          PYTHONUNBUFFERED: "1"
          TARGET_SAVED: "24"
          MAX_FRAMES: "60"
          LOOKBACK_HOURS: "6"
        run: |
          set -euo pipefail

          DAY="$(date -u +%F)"
          OUTDIR="data/raw/${DAY}/latest"

          mkdir -p "$OUTDIR"

          echo "Ingesting into $OUTDIR"

          HIMAWARI_OUT_DIR="$OUTDIR" \
          python -m himawari_ml.ingest.fetch_latest

          echo "---- directory contents ----"
          ls -la "$OUTDIR" | head -n 50 || true

      - name: Commit raw frames to data
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          DAY="$(date -u +%F)"

          echo "---- git status BEFORE add ----"
          git status --porcelain || true

          # FORCE add today's folder (bypasses .gitignore)
          git add -f "data/raw/${DAY}" || true

          echo "---- git status AFTER add ----"
          git status --porcelain || true

          if git diff --cached --quiet; then
            echo "No new frames to commit."
            exit 0
          fi

          git commit -m "ingest(hourly): ${DAY} $(date -u +'%H:%MZ')"
          git push origin data
